# lambda_alerting
## Project overview
A serverless solution using AWS Lambda to monitor and alert on specific security-related events in an AWS environment. The infrastructure is defined with Terraform and deployed via GitHub Actions.

AWS Services used:
- Lambda - notifies SNS on mutliple security events.
- EventBridge (formerly CloudWatch Events) - EB Rules invoke Lambda function when triggered by Events from CloudTrail and AWS Config.
- AWS Config - monitors Security Groups for non-compliance (any TCP/UDP port open to 0.0.0.0/0).
- CloudTrail - logs Management events, e.g. creation if IAM users.
- SNS - destination for successful Lambda invocations.
- SQS - destination for failed Lambda invocations. Failures could be processed by another AWS service at a later stage.
- S3 - storage for CloudTrail & AWS Config.
- IAM - OIDC for GitHub Actions.

## Architecture diagram
![Diagram Description](assets/infra.drawio.svg)

## Assumptions
- Single Region Deployment: All resources are deployed within a single AWS region. Notifications are bound to this region.
- Cost Consideration: Cost is not a primary concern for this solution.
- Service Access: Admin access to the aforementioned resources is available.
- Language preference: Python was chosen due to its speed of development. Additionally, more people have experience with Python compared to Golang in general.
- S3 Bucket Policies: S3 ACLs omitted in favour of Bucket Policies, following AWS recommendations.
- Terraform Code: Each Terraform file contains only the resources necessary for a single 'component' to function, prioritizing readability over compactness that comes with e.g. computed values, for loops etc.
- Commit Practices: Commits may include changes of multiple files due to the project's scope and team size (1).
- Non-private IP range: For simplicity sake, Ingress of Security Groups will be monitored for TCP/UDP ports exposed to 0.0.0.0/0 only; this might not equate to a non-private IP range definition of IETF. See [Reserved IP ranges](https://en.wikipedia.org/wiki/Reserved_IP_addresses).

## Prerequisites
Ensure access to the aforementioned AWS services, then:

Create a bucket for Terraform state:
```bash
export PREREQUISITES_BUCKET="prerequisites-lambda-infra"
aws s3api create-bucket --bucket $PREREQUISITES_BUCKET --region us-east-1
aws s3api put-bucket-versioning --bucket $PREREQUISITES_BUCKET --versioning-configuration Status=Enabled
```
Run terraform apply locally at least once to set up OIDC for GitHub Actions:
```bash
export AWS_ACCESS_KEY_ID="YOUR_KEY"
export AWS_SECRET_ACCESS_KEY="YOUR_SECRET"
terraform plan && terraform apply --auto-approve
```

In the GitHub repository, define the following Repository Variables:
```bash
AWS_ROLE_TO_ASSUME="arn:aws:iam::YOUR_ACCOUNT_ID:role/github_oidc_role"
AWS_REGION="YOUR_REGION"
```

## Deployment
After cloning the repository and addressing the **Prerequisites** section, simply pushing to the main branch will trigger updates to the infrastructure via the following jobs (sequantial):
- Static analysis with `pylint`
- Terraform code validation with `terraform validate`
- Terraform plan creation with `terraform plan`
- Terraform infrastructure provisioning with `terraform apply`

The `terraform destroy` job is also available, and can be triggered manually. Pushing to any other branch will only trigger the `pylint`, `terraform validate` and `terraform plan` jobs.

## Testing
To test the notification solution functionality:
- Create a New IAM User, e.g. `aws iam create-user --user-name Timmy --region=us-east-1`
- Create a New Access Key for an IAM User.
- Modify a Bucket's:
    - Policy
    - CORS configuration
    - Public access settings
- Open Any TCP/UDP Port to 0.0.0.0/0 on any Security Group.

To confirm that each component of the notification system works as expected:
- CloudTrail:
    - Navigate to Event history and filter by Event name or Resource Type (e.g., Event name: `CreateUser`; Resource Type: `AWS::IAM::User`).
- EventBridge:
    - Go to Rules, select a rule (e.g., `iam-user-or-key-rule`), and check the Monitoring tab for metrics like *Triggered Rules* and *Invocations*.
- AWS Config:
    - Go to Rules, select `vpc-sg-open-only-to-authorized-ports`, and check *Resources in scope* for non-compliant Security Groups.
- Lambda:
    - In the Functions section, select `lambda_notify_sns`, and under Monitor, examine metrics like *Invocations* and *Duration*. Also, review the associated CloudWatch logs.
- CloudWatch Logs:
    - Navigate to Log groups and select `/aws/lambda/lambda_notify_sns` to examine *Log events* generated by each invoked Lambda function.
- CloudWatch Metrics:
    - Use Metrics Explorer to view *All SNS Topic metrics* and see delivered notifications, published messages, etc.

During development, you can manually:

- Test Lambda Function Invocations within the Console UI and inspect the respective CloudWatch logs.
- Test EventBridge Rules by using sample events.
- Test AWS Config Ingress non-compliance by opening any Security Group TCP/UDP port to 0.0.0.0/0.

## A note on using Terraform modules
Modules provide abstraction over complex AWS resources, speeding up infrastructure setup with good defaults. For example, the 'lambda' module includes a boolean parameter `attach_create_log_group_permission` that controls whether to add the *create log group* permission to the CloudWatch logs policy.

Disadvantages include relying on an externally developed module, lack of documentation and inapplicable defaults.

## Potential Improvements
- Configure another SQS queue as a DLQ to avoid losing messages if failures occur at the SQS consumer level.
- Use CloudWatch metrics or AWS Lambda triggers to periodically check the SQS queue and alert on unprocessed events.
- A second Lambda function or a scheduled job could consume messages from the failure SQS queue and attempt reprocessing automatically.
- Handle specific failure types with backoff and retry strategies within the Lambda function, instead of relying solely on AWS retry mechanisms.
- Create an SNS subscription and optionally configure delivery status logging.

## Limitations
- Solution is limited to the current region.
- EventBridge's default event bus is used; configuring a custom bus requires additional CloudTrail setup.
- Lambda functions are built locally.
- No tests are implemented for the Lambda code.
- State locking is disabled, assuming a single contributor.
- Uploading the Terraform plan as an artifact may pose a security risk if least-privilege principles are not enforced.
- Terraform initialization output is not cached, leading to longer job initialization times in GitHub Actions jobs.
- AWS Config utilizes a managed Rule to check for 0.0.0.0/0 ingress; this rule does not specify who changed the Security Group ingress configuration, only the **account** in which the Security Group became non-compliant. Alternatives:
    - Use CloudTrail instead of AWS Config to alert on any SG Ingress rule change. This event will provide an IAM userName asssociated with the change, but an additional processing step, e.g. a Lambda function, will be needed to filter all Ingress events and then trigger the main Lambda function only when a port was opened to 0.0.0.0/0.
    - Use a custom Rule with AWS Config that can be defined using Guard DSL. This option is enticing but it was dropped due to the additional time overhead for the implementation.  

## Appendix
